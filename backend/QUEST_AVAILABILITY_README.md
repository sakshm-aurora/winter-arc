# Quest Availability System

## Overview

The Winter Arc RPG now implements **time-based quest availability** to ensure quests appear only when they should be attackable:

- **Daily Quests**: Always available for attack
- **Weekly Quests**: Only visible/attackable on weekends (Saturday-Sunday)  
- **Monthly Quests**: Only visible/attackable during last 3 days of the month
- **Sidequests**: Available when generated and not expired

## ðŸ•’ Availability Windows

### Daily Quests
- **Available**: Every day
- **Example**: Workout, Reading, Meditation
- **Logic**: Always returnable from API

### Weekly Quests  
- **Available**: Saturday (6) and Sunday (0) only
- **Example**: Weekly planning, reflection, deep work sessions
- **Logic**: `dayOfWeek === 0 || dayOfWeek === 6`

### Monthly Quests
- **Available**: Last 3 days of each month
- **Example**: Monthly review, goal setting, financial review
- **Logic**: `daysFromMonthEnd <= 2`

### Scheduled Sidequests
- **Available**: When generated by LLM at midnight and not expired
- **Duration**: 24 hours from generation
- **Logic**: Checked via `battle_events` table

## ðŸ“ New Files

### Core Module
- `utils/quest-availability.js` - Main availability logic

### Updated Routes
- `routes/quests.js` - Added `/available` endpoint and availability info
- `routes/checkins.js` - Pre-submission availability checking

## ðŸ“¡ API Endpoints

### Get Available Quests
```
GET /quests/available?date=YYYY-MM-DD
```

**Response:**
```json
{
  "date": "2024-01-20",
  "current_period": {
    "is_end_of_week": true,
    "is_end_of_month": false
  },
  "available_quests": [
    {
      "id": 1,
      "name": "Daily Workout",
      "frequency": "daily",
      "availability": {
        "available": true,
        "reason": "Daily quest - always available"
      }
    },
    {
      "id": 2, 
      "name": "Weekly Planning",
      "frequency": "weekly",
      "availability": {
        "available": true,
        "reason": "Weekly quest - available on weekends"
      }
    }
  ],
  "total_quests": 3,
  "available_count": 2
}
```

### Get All Quests with Availability Info
```
GET /quests?include_availability=true
```

**Response:**
```json
[
  {
    "id": 1,
    "name": "Daily Workout", 
    "frequency": "daily",
    "available": true,
    "availability_reason": "Daily quest - always available"
  },
  {
    "id": 2,
    "name": "Weekly Planning",
    "frequency": "weekly", 
    "available": false,
    "availability_reason": "Weekly quest - only available Saturday-Sunday",
    "next_available": "2024-01-20"
  }
]
```

### Quest Submission (Updated)
```
POST /checkins
```

Now includes availability pre-checks. Locked quests response includes:
```json
{
  "locked_quests": [
    {
      "quest_id": 2,
      "quest_name": "Weekly Planning",
      "reason": "Weekly quest - only available Saturday-Sunday", 
      "next_available": "2024-01-20"
    }
  ]
}
```

## ðŸ§ª Availability Logic

### Core Function: `isQuestAvailable(frequency, date)`

```javascript
// Daily - always available
isQuestAvailable('daily', '2024-01-15') 
// â†’ { available: true, reason: "Daily quest - always available" }

// Weekly - only weekends  
isQuestAvailable('weekly', '2024-01-15') // Monday
// â†’ { available: false, reason: "Weekly quest - only available Saturday-Sunday", next_available: "2024-01-20" }

isQuestAvailable('weekly', '2024-01-20') // Saturday
// â†’ { available: true, reason: "Weekly quest - available on weekends" }

// Monthly - last 3 days
isQuestAvailable('monthly', '2024-01-15') // Mid-month
// â†’ { available: false, reason: "Monthly quest - available in 14 days (last 3 days of month)", next_available: "2024-02-26" }

isQuestAvailable('monthly', '2024-01-29') // Last 3 days
// â†’ { available: true, reason: "Monthly quest - available during last 3 days of month" }
```

### Helper Functions

```javascript
// Check current periods
isEndOfWeek('2024-01-20') // â†’ true (Saturday)
isEndOfMonth('2024-01-29') // â†’ true (last 3 days)

// Filter quest arrays
filterAvailableQuests(allQuests, '2024-01-20')
// â†’ Returns only quests available on that date

// Add availability info
getQuestAvailabilityInfo(quest, '2024-01-20') 
// â†’ Quest object with availability fields added
```

## ðŸ“… Example Scenarios

### Regular Weekday (Monday)
```
Available Quests:
âœ… Daily Workout (daily)
âœ… Daily Reading (daily)  
âœ… Daily Meditation (daily)
âŒ Weekly Planning (weekly) - Available Saturday-Sunday
âŒ Monthly Review (monthly) - Available last 3 days of month
```

### Weekend (Saturday)
```
Available Quests:
âœ… Daily Workout (daily)
âœ… Daily Reading (daily)
âœ… Daily Meditation (daily) 
âœ… Weekly Planning (weekly) - Available on weekends!
âŒ Monthly Review (monthly) - Available last 3 days of month
```

### End of Month (January 29th)
```
Available Quests:
âœ… Daily Workout (daily)
âœ… Daily Reading (daily)
âœ… Daily Meditation (daily)
âŒ Weekly Planning (weekly) - Available Saturday-Sunday 
âœ… Monthly Review (monthly) - Available during last 3 days!
```

### Weekend + End of Month (January 31st that falls on Saturday)
```
Available Quests:
âœ… Daily Workout (daily)
âœ… Daily Reading (daily)  
âœ… Daily Meditation (daily)
âœ… Weekly Planning (weekly) - Available on weekends!
âœ… Monthly Review (monthly) - Available during last 3 days!
```

## ðŸ”§ Integration with Existing System

### Backward Compatibility
- All existing quest functionality preserved
- New availability logic only affects visibility/submission
- No database changes required for existing quests

### Battle System Integration
- Quest availability checked before submission
- Unavailable quests returned as "locked" with timing reason
- Midnight processing handles all frequencies correctly
- LLM narratives include appropriate quest types for the period

### Frontend Integration
- Use `/quests/available` endpoint for quest selection UI
- Show unavailable quests with "Next Available" timing
- Display weekend/month-end periods prominently
- Filter quest lists by availability in real-time

## ðŸŽ¯ Benefits

### User Experience
- **Clear Expectations**: Users know when quests will be available
- **Strategic Planning**: Can plan weekend/month-end activities
- **Reduced Frustration**: No confusion about locked quests

### Game Design
- **Authentic Periods**: Weekly planning happens on weekends
- **Monthly Cadence**: Reviews happen at natural month boundaries  
- **Balanced Gameplay**: Not overwhelmed with all quest types daily

### Token Efficiency
- **Focused Narratives**: LLM processes quest types appropriate for the period
- **Contextual Stories**: Better storylines when quest types match timing
- **Reduced Complexity**: Simpler daily processing logic

## ðŸš€ Usage

### For Frontend Developers
```javascript
// Get only quests available right now
const availableQuests = await fetch('/quests/available');

// Check if specific quest is available
const questInfo = await fetch('/quests?include_availability=true');
questInfo.forEach(quest => {
  if (quest.available) {
    // Show as actionable
  } else {
    // Show as locked with next_available date
  }
});
```

### For Backend Integration
```javascript
const { isQuestAvailable, filterAvailableQuests } = require('./utils/quest-availability');

// Check single quest
const availability = isQuestAvailable('weekly', '2024-01-20');

// Filter quest list
const available = filterAvailableQuests(allQuests, currentDate);
```

This system ensures quests appear exactly when they should be actionable, creating a more intuitive and strategically interesting gameplay experience!
